/**
 * # GameWindow
 * Copyright(c) 2015 Stefano Balietti
 * MIT Licensed
 *
 * GameWindow provides a handy API to interface nodeGame with the
 * browser window
 *
 * Creates a custom root element inside the HTML page, and insert an
 * iframe element inside it.
 *
 * Dynamic content can be loaded inside the iframe without losing the
 * javascript state inside the page.
 *
 * Defines a number of profiles associated with special page layout.
 *
 * Depends on JSUS and nodegame-client.
 */
(function(e,t){"use strict";function l(e,t){function r(i){var s;s=JSUS.getIFrameDocument(e),e.removeEventListener("load",r,!1),n.removeEventListener("load",r,!1),t&&setTimeout(function(){t()},120)}var n;n=e.contentWindow,e.addEventListener("load",r,!1),n.addEventListener("load",r,!1)}function c(e,t){function r(i){var s;s=JSUS.getIFrameDocument(e);if(i.type==="load"||s.readyState==="complete")e.detachEvent("onreadystatechange",r),n.detachEvent("onload",r),t&&setTimeout(function(){t()},120)}var n;n=e.contentWindow,e.attachEvent("onreadystatechange",r),n.attachEvent("onload",r)}function h(e,t){W.isIE?c(e,t):l(e,t)}function p(){this.setStateLevel("UNINITIALIZED");if("undefined"==typeof e)throw new Error("GameWindow: no window found. Are you in a browser?");if("undefined"==typeof t)throw new Error("GameWindow: nodeGame not found");t.silly("node-window: loading..."),this.frameName=null,this.frameElement=null,this.frameWindow=null,this.frameDocument=null,this.frameRoot=null,this.headerElement=null,this.headerName=null,this.headerRoot=null,this.headerPosition=null,this.defaultHeaderPosition="left",this.conf={},this.areLoading=0,this.cacheSupported=null,this.cache={},this.currentURIs={},this.globalLibs=[],this.frameLibs={},this.stateLevel=null,this.waitScreen=null,this.listenersAdded=null,this.screenState=t.constants.screenLevels.ACTIVE,this.isIE=!!document.createElement("span").attachEvent,this.addDefaultSetups(),this.addDefaultListeners(),setTimeout(function(){(function(e){e.length>=1&&(e[0].style.display="none")})(document.getElementsByTagName("noscript"))},1e3),this.init(p.defaults),t.silly("node-window: created.")}function d(e,t,r,i,s,o,u){var a,f;r=W.getElementById(i),a=W.getIFrameDocument(r).documentElement,s&&(a.innerHTML=e.cache[t].contents),i===e.frameName&&(e.frameWindow=r.contentWindow,e.frameDocument=e.getIFrameDocument(r),e.conf.rightClickDisabled&&n.disableRightClick(e.frameDocument)),v(r),f=function(){g(r,e.globalLibs.concat(e.frameLibs.hasOwnProperty(t)?e.frameLibs[t]:[])),o&&(e.cache[t].contents=a.innerHTML),u()},s?m(r,f):f()}function v(e){var t,n,r,i;n=W.getIFrameDocument(e),r=W.getElementsByClassName(n,"injectedlib","script");for(t=0;t<r.length;t++)i=r[t],i.parentNode.removeChild(i)}function m(e,t){var n,r,i,s,o,u,a,f,l,c;n=W.getIFrameDocument(e),r=W.getIFrameAnyChild(e),l=1,s=n.getElementsByTagName("script");for(o=0;o<s.length;o++){i=s[o],i.parentNode.removeChild(i),u=document.createElement("script"),i.innerHTML&&(u.innerHTML=i.innerHTML),c=!1;for(a=0;a<i.attributes.length;a++)f=i.attributes[a],u.setAttribute(f.name,f.value),f.name==="src"&&(c=!0);c&&(++l,u.onload=function(e){return function(){e.onload=null,--l,l<=0&&t()}}(u)),r.appendChild(u)}--l,l<=0&&t()}function g(e,t){var n,r,i,s;n=W.getIFrameAnyChild(e);for(i=0;i<t.length;i++)s=t[i],r=document.createElement("script"),r.className="injectedlib",r.src=s,n.appendChild(r)}function y(e,t){return e.areLoading=e.areLoading+t,e.areLoading===0}function b(e,t){var n;if(!e.frameElement)throw new Error("adaptFrame2HeaderPosition: frame not found.");n=e.headerPosition||"top",t==="bottom"&&n!=="bottom"&&e.getFrameRoot().insertBefore(e.headerElement,e.frameElement),e.removeClass(e.frameElement,"ng_mainframe-header-[a-z-]*");switch(n){case"right":e.addClass(e.frameElement,"ng_mainframe-header-vertical-r");break;case"left":e.addClass(e.frameElement,"ng_mainframe-header-vertical-l");break;case"top":e.addClass(e.frameElement,"ng_mainframe-header-horizontal"),e.headerElement&&e.getFrameRoot().insertBefore(e.headerElement,e.frameElement);break;case"bottom":e.addClass(e.frameElement,"ng_mainframe-header-horizontal"),e.headerElement&&e.getFrameRoot().insertBefore(e.headerElement,e.frameElement.nextSibling)}}var n=t.JSUS;if(!n)throw new Error("GameWindow: JSUS object not found. Aborting.");var r=n.get("DOM");if(!r)throw new Error("GameWindow: JSUS DOM object not found. Aborting.");var i=t.constants,s=i.windowLevels,o=i.screenLevels,u=i.stageLevels.CALLBACK_EXECUTED,a=s.LOADING,f=!1;p.prototype=r,p.prototype.constructor=p,p.defaults={},p.defaults.promptOnleaveText="",p.defaults.promptOnleave=!0,p.defaults.noEscape=!0,p.defaults.waitScreen=undefined,p.defaults.disableRightClick=!1,p.defaults.cacheDefaults={loadCache:!0,storeCacheNow:!1,storeCacheLater:!1},p.prototype.init=function(e){var r,s;this.setStateLevel("INITIALIZING"),e=e||{},this.conf=n.merge(this.conf,e),this.conf.promptOnleave?this.promptOnleave():this.conf.promptOnleave===!1&&this.restoreOnleave(),this.conf.noEscape?this.noEscape():this.conf.noEscape===!1&&this.restoreEscape(),this.conf.waitScreen!==!1?(this.waitScreen&&(this.waitScreen.destroy(),this.waitScreen=null),this.waitScreen=new t.WaitScreen(this.conf.waitScreen),r=i.stageLevels,s=t.game.getStageLevel(),s!==r.UNINITIALIZED&&(t.game.paused?this.lockScreen(this.waitScreen.defaultTexts.paused):s===r.DONE?this.lockScreen(this.waitScreen.defaultTexts.waiting):s!==r.PLAYING&&this.lockScreen(this.waitScreen.defaultTexts.stepping))):this.waitScreen&&(this.waitScreen.destroy(),this.waitScreen=null),this.conf.defaultHeaderPosition&&(this.defaultHeaderPosition=this.conf.defaultHeaderPosition),this.conf.disableRightClick?this.disableRightClick():this.conf.disableRightClick===!1&&this.enableRightClick(),this.setStateLevel("INITIALIZED"),t.silly("node-window: inited.")},p.prototype.reset=function(){this.isScreenLocked()&&this.unlockScreen(),t.widgets&&t.widgets.destroyAll(),this.getFrame()&&this.destroyFrame(),this.getHeader()&&this.destroyHeader(),this.areLoading=0,this.clearCache(),t.silly("node-window: reseted.")},p.prototype.setStateLevel=function(e){if("string"!=typeof e)throw new TypeError("GameWindow.setStateLevel: level must be string.");if("undefined"==typeof s[e])throw new Error("GameWindow.setStateLevel: unrecognized level: "+e+".");this.stateLevel=s[e]},p.prototype.getStateLevel=function(){return this.stateLevel},p.prototype.isReady=function(){return this.stateLevel===s.LOADED||this.stateLevel===s.INITIALIZED},p.prototype.setScreenLevel=function(e){if("string"!=typeof e)throw new TypeError("GameWindow.setScreenLevel: level must be string.");if("undefined"==typeof o[e])throw new Error("GameWindow.setScreenLevel: unrecognized level: "+e+".");this.screenState=o[e]},p.prototype.getScreenLevel=function(){return this.screenState},p.prototype.getFrame=function(){return this.frameElement||this.frameName&&(this.frameElement=document.getElementById(this.frameName)),this.frameElement},p.prototype.getFrameName=function(){var e;if(!this.frameName||this.stateLevel===a)e=this.getFrame(),this.frameName=e?e.name||e.id:null;return this.frameName},p.prototype.getFrameWindow=function(){var e;if(!this.frameWindow||this.stateLevel===a)e=this.getFrame(),this.frameWindow=e?e.contentWindow:null;return this.frameWindow},p.prototype.getFrameDocument=function(){var e;if(!this.frameDocument||this.stateLevel===a)e=this.getFrame(),this.frameDocument=e?this.getIFrameDocument(e):null;return this.frameDocument},p.prototype.getFrameRoot=function(){var e;return this.frameRoot||(e=this.getFrame(),this.frameRoot=e?e.parentNode:null),this.frameRoot},p.prototype.generateFrame=function(e,t,r){var i;if(!r&&this.frameElement)throw new Error("GameWindow.generateFrame: a frame element is already existing. It cannot be duplicated.");e=e||this.frameRoot||document.body;if(!n.isElement(e))throw new Error("GameWindow.generateFrame: invalid root element.");t=t||"ng_mainframe";if("string"!=typeof t)throw new Error("GameWindow.generateFrame: frameName must be string.");if(document.getElementById(t))throw new Error("GameWindow.generateFrame: frameName must be unique.");return i=W.addIFrame(e,t),i.contentWindow.location.replace("about:blank"),i.frameBorder=0,this.setFrame(i,t,e),this.frameElement&&b(this),i},p.prototype.setFrame=function(e,t,r){if(!n.isElement(e))throw new Error("GameWindow.setFrame: iframe must be HTMLElement.");if("string"!=typeof t)throw new Error("GameWindow.setFrame: iframeName must be string.");if(!n.isElement(r))throw new Error("GameWindow.setFrame: invalid root element.");return this.frameRoot=r,this.frameName=t,this.frameElement=e,this.frameWindow=e.contentWindow,this.frameDocument=W.getIFrameDocument(e),e},p.prototype.destroyFrame=function(){this.clearFrame(),this.frameRoot&&this.frameRoot.removeChild(this.frameElement),this.frameElement=null,this.frameWindow=null,this.frameDocument=null,this.frameRoot=null},p.prototype.clearFrame=function(){var t,r;t=this.getFrame();if(!t)throw new Error("GameWindow.clearFrame: cannot detect frame.");r=t.name||t.id,t.onload=null;try{this.getFrameDocument().documentElement.innerHTML=""}catch(i){n.getIFrameDocument(t).documentElement&&n.removeChildrenFromNode(n.getIFrameDocument(t).documentElement)}this.frameElement=t,this.frameWindow=e.frames[r],this.frameDocument=W.getIFrameDocument(t)},p.prototype.generateHeader=function(e,t,r){var i;if(!r&&this.headerElement)throw new Error("GameWindow.generateHeader: a header element is already existing. It cannot be duplicated.");e=e||document.body||document.lastElementChild;if(!n.isElement(e))throw new Error("GameWindow.generateHeader: invalid root element.");t=t||"ng_header";if("string"!=typeof t)throw new Error("GameWindow.generateHeader: headerName must be string.");if(document.getElementById(t))throw new Error("GameWindow.generateHeader: headerName must be unique.");return i=this.addElement("div",e,t),this.frameElement&&this.defaultHeaderPosition!=="bottom"&&this.getFrameRoot().insertBefore(i,this.frameElement),this.setHeader(i,t,e),this.setHeaderPosition(this.defaultHeaderPosition),i},p.prototype.setHeaderPosition=function(e){var n,r,i;if("string"!=typeof e)throw new TypeError("GameWindow.setHeaderPosition: position must be string.");r=e.toLowerCase();if(this.headerPosition===r)return;n={top:"ng_header_position-horizontal-t",bottom:"ng_header_position-horizontal-b",right:"ng_header_position-vertical-r",left:"ng_header_position-vertical-l"};if("undefined"==typeof n[r]){t.err("GameWindow.setHeaderPosition: invalid header position: "+r+".");return}if(!this.headerElement)throw new Error("GameWindow.setHeaderPosition: headerElement not found.");W.removeClass(this.headerElement,"ng_header_position-[a-z-]*"),W.addClass(this.headerElement,n[r]),i=this.headerPosition,this.headerPosition=r,this.frameElement&&b(this,i)},p.prototype.setHeader=function(e,t,r){if(!n.isElement(e))throw new Error("GameWindow.setHeader: header must be HTMLElement.");if("string"!=typeof t)throw new Error("GameWindow.setHeader: headerName must be string.");if(!n.isElement(r))throw new Error("GameWindow.setHeader: invalid root element.");return this.headerElement=e,this.headerName=t,this.headerRoot=r,this.headerElement},p.prototype.getHeader=function(){return this.headerElement||(this.headerElement=this.headerName?document.getElementById(this.headerName):null),this.headerElement},p.prototype.getHeaderName=function(){var e;return this.headerName||(e=this.getHeader(),this.headerName=e?e.id:null),this.headerName},p.prototype.getHeaderRoot=function(){var e;return this.headerRoot||(e=this.getHeader(),this.headerRoot=e?e.parentNode:null),this.headerRoot},p.prototype.destroyHeader=function(){this.clearHeader(),this.headerRoot.removeChild(this.headerElement),this.headerElement=null,this.headerName=null,this.headerRoot=null,this.headerPosition=null},p.prototype.clearHeader=function(){var e;e=this.getHeader();if(!e)throw new Error("GameWindow.clearHeader: cannot detect header.");this.headerElement.innerHTML=""},p.prototype.setupFrame=function(e){if("string"!=typeof e)throw new TypeError("GameWindow.setup: profile must be string.");switch(e){case"MONITOR":this.getFrame()||this.generateFrame(),t.widgets.append("NextPreviousState"),t.widgets.append("GameSummary"),t.widgets.append("StateDisplay"),t.widgets.append("StateBar"),t.widgets.append("DataBar"),t.widgets.append("MsgBar"),t.widgets.append("GameBoard"),t.widgets.append("ServerInfoDisplay"),t.widgets.append("Wall"),t.conf.host&&this.addCSS(this.getFrameRoot(),t.conf.host+"/stylesheets/monitor.css");break;case"PLAYER":this.generateHeader(),t.game.visualState=t.widgets.append("VisualState",this.headerElement),t.game.timer=t.widgets.append("VisualTimer",this.headerElement),t.game.stateDisplay=t.widgets.append("StateDisplay",this.headerElement);case"SOLO_PLAYER":this.getFrame()||this.generateFrame(),t.conf.host&&this.addCSS(this.getFrameRoot(),t.conf.host+"/stylesheets/nodegame.css");break;default:throw new Error("GameWindow.setupFrame: unknown profile type: "+e+".")}},p.prototype.initLibs=function(e,t){if(e&&!n.isArray(e))throw new TypeError("GameWindow.initLibs: globalLibs must be array or undefined.");if(t&&"object"!=typeof framLibs)throw new TypeError("GameWindow.initLibs: frameLibs must be object or undefined.");if(!e&&!t)throw new Error("GameWindow.initLibs: frameLibs and frameLibs cannot be both undefined.");this.globalLibs=this.globalLibs.concat(e||[]),n.mixin(this.frameLibs,t)},p.prototype.preCacheTest=function(e,t){var n,r;t=t||"/pages/testpage.htm";if("string"!=typeof t)throw new TypeError("GameWindow.precacheTest: uri must string or undefined.");n=document.createElement("iframe"),n.style.display="none",r="preCacheTest",n.id=r,n.name=r,document.body.appendChild(n),n.contentWindow.location.replace(t),h(n,function(){try{W.getIFrameDocument(n).documentElement.innerHTML="a",W.cacheSupported=!0}catch(t){W.cacheSupported=!1}document.body.removeChild(n),e&&e()})},p.prototype.preCache=function(r,i){var s,o,u,a,f,l;"string"==typeof r&&(r=[r]);if(!n.isArray(r))throw new TypeError("GameWindow.preCache: uris must be string or array.");if(i&&"function"!=typeof i)throw new TypeError("GameWindow.preCache: callback must be function or undefined.");if(!r.length){i&&i();return}s=this;if(this.cacheSupported===null){this.preCacheTest(function(){s.preCache(r,i)});return}if(this.cacheSupported===!1){t.warn("GameWindow.preCache: caching is not supported by your browser."),i&&i();return}o=0;for(a=0;a<r.length;a++)u=r[a],f=document.createElement("iframe"),f.style.display="none",l="tmp_iframe_"+a,f.id=l,f.name=l,document.body.appendChild(f),function(e,t){h(t,function(){var n,u;n=W.getIFrameDocument(t),u=n.documentElement,s.cache[e]={contents:u.innerHTML,cacheOnClose:!1},document.body.removeChild(t),o++,o>=r.length&&i&&i()})}(u,f),e.frames[l].location.replace(u)},p.prototype.clearCache=function(){this.cache={}},p.prototype.getElementById=function(e){var t,n;return n=this.getFrameDocument(),t=null,n&&n.getElementById&&(t=n.getElementById(e)),t||(t=document.getElementById(e)),t},p.prototype.getElementsByTagName=function(e){var t;return t=this.getFrameDocument(),t?t.getElementsByTagName(e):document.getElementsByTagName(e)},p.prototype.loadFrame=function(e,n,r){var i,s,o,u,a,f,l,c,v,m,g;if("string"!=typeof e)throw new TypeError("GameWindow.loadFrame: uri must be string.");if(n&&"function"!=typeof n)throw new TypeError("GameWindow.loadFrame: func must be function or undefined.");if(r&&"object"!=typeof r)throw new TypeError("GameWindow.loadFrame: opts must be object or undefined.");r=r||{},a=this.getFrame(),f=this.frameName;if(!a)throw new Error("GameWindow.loadFrame: no frame found.");if(!f)throw new Error("GameWindow.loadFrame: frame has no name.");this.setStateLevel("LOADING"),i=this,c=a.contentWindow,l=W.getIFrameDocument(a),m=l.readyState,m=m==="complete",s=p.defaults.cacheDefaults.loadCache,o=p.defaults.cacheDefaults.storeCacheNow,u=p.defaults.cacheDefaults.storeCacheLater;if(r.cache){if(r.cache.loadMode)if(r.cache.loadMode==="reload")s=!1;else{if(r.cache.loadMode!=="cache")throw new Error("GameWindow.loadFrame: unkown cache load mode: "+r.cache.loadMode+".");s=!0}if(r.cache.storeMode)if(r.cache.storeMode==="off")o=!1,u=!1;else if(r.cache.storeMode==="onLoad")o=!0,u=!1;else{if(r.cache.storeMode!=="onClose")throw new Error("GameWindow.loadFrame: unkown cache store mode: "+r.cache.storeMode+".");o=!1,u=!0}}if(this.cacheSupported===null){this.preCacheTest(function(){i.loadFrame(e,n,r)});return}this.cacheSupported===!1?(o=!1,u=!1,s=!1):(g=this.currentURIs[f],this.cache.hasOwnProperty(g)&&this.cache[g].cacheOnClose&&(v=l.documentElement,this.cache[g].contents=v.innerHTML),this.cache.hasOwnProperty(e)||(this.cache[e]={contents:null,cacheOnClose:!1}),this.cache[e].cacheOnClose=u,this.cache[e].contents===null&&(s=!1)),this.currentURIs[f]=e,y(this,1),(!s||!m)&&h(a,function(){d(i,e,a,f,s,o,function(){i.updateLoadFrameState(n)})}),s?m&&d(this,e,a,f,s,o,function(){i.updateLoadFrameState(n)}):c.location.replace(e),c.node=t},p.prototype.updateLoadFrameState=function(e){var n,r;n=y(this,-1),n&&this.setStateLevel("LOADED"),e&&e.call(t.game),t.events.ee.game.emit("FRAME_LOADED"),t.events.ee.stage.emit("FRAME_LOADED"),t.events.ee.step.emit("FRAME_LOADED"),n?(r=t.game.getStageLevel(),r===u&&t.emit("LOADED")):t.silly("game-window: "+this.areLoading+" frames "+"still loading.")},p.prototype.clearPageBody=function(){this.reset(),document.body.innerHTML=""},p.prototype.clearPage=function(){this.reset();try{document.documentElement.innerHTML=""}catch(e){this.removeChildrenFromNode(document.documentElement)}},t.GameWindow=p})("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){var n=t.GameWindow,r=t.JSUS;n.prototype.addDefaultSetups=function(){t.registerSetup("window",function(e){return e=r.merge(W.conf,e),this.window.init(e),e}),t.registerSetup("page",function(e){var t,n;if(!e)return;return e.clearBody&&this.window.clearPageBody(),e.clear&&this.window.clearPage(),"string"==typeof e.title&&(e.title={title:e.title}),"object"==typeof e.title&&(document.title=e.title.title,e.title.addToBody&&(t=document.createElement("h1"),t.innerHTML=e.title.title,n=document.body,n.innerHTML===""?n.appendChild(t):n.insertBefore(t,n.firstChild))),e}),t.registerSetup("frame",function(e){var n,r,i,s,o,u,a;if(!e)return;if(e.generate){if("object"!=typeof e.generate){t.warn("node.setup.frame: conf.generate must be object or undefined.");return}if(e.generate.root){if("string"!=typeof e.generate.root){t.warn("node.setup.frame: conf.generate.root must be string or undefined.");return}a=e.generate.root,o=e.generate.force,s=e.generate.name}u=this.window.getElementById(a),u||(u=this.window.getScreen());if(!u){t.warn("node.setup.frame: could not find valid root element to generate new frame.");return}this.window.generateFrame(u,s,o)}if(e.load){if("object"==typeof e.load)n=e.load.url,r=e.load.cb,i=e.load.options;else{if("string"!=typeof e.load){t.warn("node.setup.frame: conf.load must be string, object or undefined.");return}n=e.load}this.window.loadFrame(n,r,i)}return e.clear&&this.window.clearFrame(),e.destroy&&this.window.destroyFrame(),e}),t.registerSetup("header",function(e){var n,r,i,s,o,u,a;if(!e)return;if(e.generate){if("object"!=typeof e.generate){t.warn("node.setup.header: conf.generate must be object or undefined.");return}if(e.generate.root){if("string"!=typeof e.generate.root){t.warn("node.setup.header: conf.generate.root must be string or undefined.");return}a=e.generate.root,o=e.generate.force,s=e.generate.name}u=this.window.getElementById(a),u||(u=this.window.getScreen());if(!u){t.warn("node.setup.frame: could not find valid root element to generate new frame.");return}this.window.generateFrame(u,s,o)}if(e.position){if("string"!=typeof e.position){t.warn("node.setup.header: conf.position must be string or undefined.");return}this.window.setHeaderPosition(e.position)}return e.clear&&this.window.clearHeader(),e.destroy&&this.window.destroyHeader(),e})}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";var n=t.GameWindow,r=t.JSUS;n.prototype.noEscape=function(t){t=t||e,t.document.onkeydown=function(t){var n=e.event?event.keyCode:t.keyCode;if(n===27)return!1},this.conf.noEscape=!0},n.prototype.restoreEscape=function(t){t=t||e,t.document.onkeydown=null,this.conf.noEscape=!1},n.prototype.promptOnleave=function(t,n){t=t||e,n="undefined"!=typeof n?n:this.conf.promptOnleaveText,t.onbeforeunload=function(t){return t=t||e.event,t&&(t.returnValue=n),n},this.conf.promptOnleave=!0},n.prototype.restoreOnleave=function(t){t=t||e,t.onbeforeunload=null,this.conf.promptOnleave=!1},n.prototype.disableRightClick=function(){this.frameElement&&r.disableRightClick(this.getFrameDocument()),r.disableRightClick(document),this.conf.rightClickDisabled=!0},n.prototype.enableRightClick=function(){this.frameElement&&r.enableRightClick(this.getFrameDocument()),r.enableRightClick(document),this.conf.rightClickDisabled=!1}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";var n=t.JSUS,r=t.GameWindow,i=t.constants.screenLevels;r.prototype.lockScreen=function(e){var t;t=this;if(!this.waitScreen)throw new Error("GameWindow.lockScreen: waitScreen not found.");if(e&&"string"!=typeof e)throw new TypeError("GameWindow.lockScreen: text must be string or undefined");this.setScreenLevel("LOCKING"),e=e||"Screen locked. Please wait...",this.waitScreen.lock(e),this.setScreenLevel("LOCKED")},r.prototype.unlockScreen=function(){if(!this.waitScreen)throw new Error("GameWindow.unlockScreen: waitScreen not found.");if(!this.isScreenLocked())throw new Error("GameWindow.unlockScreen: screen is not locked.");this.setScreenLevel("UNLOCKING"),this.waitScreen.unlock(),this.setScreenLevel("ACTIVE")},r.prototype.isScreenLocked=function(){return this.getScreenLevel()!==i.ACTIVE}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e){"use strict";function t(e){var t;if("string"==typeof e)t=W.getElementById(e);else{if(!JSUS.isElement(e))throw new TypeError(prefix+": idOrObj must be string "+" or HTML Element.");t=e}return t}var n=e.GameWindow;n.prototype.addDefaultListeners=function(n){return this.listenersAdded&&!n?(e.err("node.window.addDefaultListeners: listeners already added once. Use the force flag to re-add."),!1):(e.on("NODEGAME_GAME_CREATED",function(){W.init(e.conf.window)}),e.on("HIDE",function(e){var n;n=t(e,"GameWindow.on.HIDE"),n&&(n.style.display="none")}),e.on("SHOW",function(e){var n;n=t(e,"GameWindow.on.SHOW"),n&&(n.style.display="")}),e.on("TOGGLE",function(e){var n;n=t(e,"GameWindow.on.TOGGLE"),n&&(n.style.display==="none"?n.style.display="":n.style.display="none")}),e.on("INPUT_DISABLE",function(e){W.toggleInputs(e,!0)}),e.on("INPUT_ENABLE",function(e){W.toggleInputs(e,!1)}),e.on("INPUT_TOGGLE",function(e){W.toggleInputs(e)}),window.onunload=function(){var t;e.socket.disconnect();for(t=-1;++t<1e5;);},this.listenersAdded=!0,e.silly("node-window: listeners added."),!0)}}("undefined"!=typeof node?node:undefined),function(e,t){"use strict";function i(e,t){var i,s,o,u;"undefined"==typeof t&&(t=!0);for(i=-1;++i<r;){o=e.getElementsByTagName(n[i]),u=o.length;for(s=-1;++s<u;)t?o[s].disabled||(o[s].disabled=!0,W.waitScreen.lockedInputs.push(o[s])):o[s].disabled&&(o[s].disabled=!1)}t||(W.waitScreen.lockedInputs=[])}function s(e){e=e||W.waitScreen.defaultTexts.waiting,node.game.shouldStep()||(W.isScreenLocked()?W.waitScreen.updateText(e):W.lockScreen(e))}function o(e){e=e||W.waitScreen.defaultTexts.stepping,W.isScreenLocked()?W.waitScreen.updateText(e):W.lockScreen(e)}function u(){W.isScreenLocked()&&W.unlockScreen()}function a(e){e=e||W.waitScreen.defaultTexts.paused,W.isScreenLocked()?(W.waitScreen.beforePauseInnerHTML=W.waitScreen.waitingDiv.innerHTML,W.waitScreen.updateText(e)):W.lockScreen(e)}function f(){W.isScreenLocked()&&(W.waitScreen.beforePauseInnerHTML!==null?(W.waitScreen.updateText(W.waitScreen.beforePauseInnerHTML),W.waitScreen.beforePauseInnerHTML=null):W.unlockScreen())}function l(e){e=e||{},this.id=e.id||"ng_waitScreen",this.root=e.root||null,this.waitingDiv=null,this.beforePauseInnerHTML=null,this.enabled=!1,this.defaultTexts={waiting:e.waitingText||"Waiting for other players to be done...",stepping:e.steppingText||"Initializing game step, will be ready soon...",paused:e.pausedText||"Game is paused. Please wait."},this.lockedInputs=[],this.enable()}e.WaitScreen=l,l.version="0.7.0",l.description="Show a standard waiting screen";var n,r;n=["button","select","textarea","input"],r=n.length,l.prototype.enable=function(){if(this.enabled)return;node.events.ee.game.on("REALLY_DONE",s),node.events.ee.game.on("STEPPING",o),node.events.ee.game.on("PLAYING",u),node.events.ee.game.on("PAUSED",a),node.events.ee.game.on("RESUMED",f),this.enabled=!0},l.prototype.disable=function(){if(!this.enabled)return;node.events.ee.game.off("REALLY_DONE",s),node.events.ee.game.off("STEPPING",o),node.events.ee.game.off("PLAYING",u),node.events.ee.game.off("PAUSED",a),node.events.ee.game.off("RESUMED",f),this.enabled=!1},l.prototype.lock=function(e){var t;"undefined"==typeof document.getElementsByTagName&&node.warn("WaitScreen.lock: cannot lock inputs."),i(document),t=W.getIFrameDocument(W.getFrame()),t&&i(t),this.waitingDiv||(this.root||(this.root=W.getFrameRoot()||document.body),this.waitingDiv=W.addDiv(this.root,this.id)),this.waitingDiv.style.display==="none"&&(this.waitingDiv.style.display=""),this.waitingDiv.innerHTML=e},l.prototype.unlock=function(){var e,t,n,r,s;this.waitingDiv&&this.waitingDiv.style.display===""&&(this.waitingDiv.style.display="none");try{n=this.lockedInputs.length;for(t=-1;++t<n;)this.lockedInputs[t].removeAttribute("disabled");this.lockedInputs=[]}catch(o){i(W.getIFrameDocument(W.getFrame()),!1)}},l.prototype.updateText=function(e,t){t=t||!1;if("string"!=typeof e)throw new TypeError("WaitScreen.updateText: text must be string.");t?this.waitingDiv.appendChild(document.createTextNode(e)):this.waitingDiv.innerHTML=e},l.prototype.destroy=function(){W.isScreenLocked()&&(W.setScreenLevel("UNLOCKING"),this.unlock(),W.setScreenLevel("ACTIVE")),this.waitingDiv&&this.waitingDiv.parentNode.removeChild(this.waitingDiv),this.disable()}}("undefined"!=typeof node?node:module.parent.exports.node,"undefined"!=typeof window?window:module.parent.exports.window),function(e,t){"use strict";var n=t.JSUS,r=t.constants,i=t.GameWindow;i.prototype.getRecipientSelector=function(e){var t;return t=document.createElement("select"),"undefined"!=typeof e&&(t.id=e),this.addStandardRecipients(t),t},i.prototype.addRecipientSelector=function(e,t){var n;return e?(n=this.getRecipientSelector(t),e.appendChild(n)):!1},i.prototype.addStandardRecipients=function(e){var t;t=document.createElement("option"),t.value="ALL",t.appendChild(document.createTextNode("ALL")),e.appendChild(t),t=document.createElement("option"),t.value="CHANNEL",t.appendChild(document.createTextNode("CHANNEL")),e.appendChild(t),t=document.createElement("option"),t.value="ROOM",t.appendChild(document.createTextNode("ROOM")),e.appendChild(t),t=document.createElement("option"),t.value="SERVER",t.appendChild(document.createTextNode("SERVER")),e.appendChild(t)},i.prototype.populateRecipientSelector=function(e,t){var r,i;if("object"!=typeof t||"object"!=typeof e)return;this.removeChildrenFromNode(e),this.addStandardRecipients(e),r=t.db||t,n.each(r,function(t){i=document.createElement("option"),i.value=t.id,i.appendChild(document.createTextNode(t.name||t.id)),e.appendChild(i)})},i.prototype.getActionSelector=function(e){var t=document.createElement("select");return"undefined"!=typeof e&&(t.id=e),this.populateSelect(t,r.action),t},i.prototype.addActionSelector=function(e,t){var n;if(!e)return;return n=this.getActionSelector(t),e.appendChild(n)},i.prototype.getTargetSelector=function(e){var t;return t=document.createElement("select"),"undefined"!=typeof e&&(t.id=e),this.populateSelect(t,r.target),t},i.prototype.addTargetSelector=function(e,t){if(!e)return;var n=this.getTargetSelector(t);return e.appendChild(n)}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";function s(e,t){var n,r,i,s,o,u;t=t||document,n=["button","select","textarea","input"],i=n.length;for(r=0;r<i;r++){o=t.getElementsByTagName(n[r]),u=o.length;for(s=0;s<u;s++)"undefined"==typeof e&&(e=o[s].disabled?!1:!0),e?o[s].disabled=e:o[s].removeAttribute("disabled")}}var n=t.GameWindow,r=t.JSUS,i=r.get("DOM");n.prototype.getScreen=function(){var e=this.getFrameDocument();return e?e=e.body||e:e=document.body||document.lastElementChild,e},n.prototype.write=function(e,t){"string"==typeof t?t=this.getElementById(t):t||(t=this.getScreen());if(!t)throw new Error("GameWindow.write: could not determine where to write.");return i.write(t,e)},n.prototype.writeln=function(e,t,n){"string"==typeof t?t=this.getElementById(t):t||(t=this.getScreen());if(!t)throw new Error("GameWindow.writeln: could not determine where to write.");return i.writeln(t,e,n)},n.prototype.generateUniqueId=function(e){var t,n;t=""+(e||r.randomInt(0,1e3)),n=this.getElementById(t);while(n)t=""+e+"_"+r.randomInt(0,1e3),n=this.getElementById(t);return t},n.prototype.toggleInputs=function(e,n){var r;if(!document.getElementsByTagName)return t.err("GameWindow.toggleInputs: getElementsByTagName not found."),!1;if(e&&"string"==typeof e)throw new Error("GameWindow.toggleInputs: id must be string or undefined.");if(e){r=this.getElementById(e);if(!r)throw new Error("GameWindow.toggleInputs: no elements found with id "+e+".");s(n,r)}else s(n),r=this.getFrameDocument(),r&&s(n,r);return!0},n.prototype.getScreenInfo=function(){var t=e.screen;return{height:t.height,widht:t.width,availHeight:t.availHeight,availWidth:t.availWidht,colorDepth:t.colorDepth,pixelDepth:t.pixedDepth}},n.prototype.getLoadingDots=function(e,t){function o(){n.innerHTML=".",clearInterval(s)}var n,r,i,s;if(e&e<0)throw new Error("GameWindow.getLoadingDots: len < 0.");e=e||5,n=document.createElement("span"),n.id=t||"span_dots",i="";for(r=0;r<e;r++)i+=".";return s=setInterval(function(){n.innerHTML!==i?n.innerHTML=n.innerHTML+".":n.innerHTML="."},1e3),{span:n,stop:o}},n.prototype.addLoadingDots=function(e,t,n){return e.appendChild(this.getLoadingDots(t,n).span)},n.prototype.getEventButton=function(e,n,r,i){var s;if("string"!=typeof e)throw new TypeError("GameWindow.getEventButton: event must be string.");return s=this.getButton(r,n,i),s.onclick=function(){t.emit(e)},s},n.prototype.addEventButton=function(e,t,n,r,i){var s;if(!e)return;return n||(n=this.getScreen()),s=this.getEventButton(e,t,r,i),n.appendChild(s)}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(){"use strict";node.window=new node.GameWindow,"undefined"!=typeof window&&(window.W=node.window)}(),function(e){"use strict";function t(e){this.canvas=e,this.ctx=e.getContext("2d"),this.centerX=e.width/2,this.centerY=e.height/2,this.width=e.width,this.height=e.height}e.Canvas=t,t.prototype={constructor:t,drawOval:function(e){var t=e.x/e.scale_x,n=e.y/e.scale_y,r=e.radius||100;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.scale(e.scale_x,e.scale_y),this.ctx.beginPath(),this.ctx.arc(t,n,r,0,Math.PI*2,!1),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},drawLine:function(e){var t=e.x,n=e.y,r=e.length,i=e.angle,s=-Math.cos(i)*r+e.x,o=Math.sin(i)*r+e.y;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(t,n),this.ctx.lineTo(s,o),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},scale:function(e,t){this.ctx.scale(e,t),this.centerX=this.canvas.width/2/e,this.centerY=this.canvas.height/2/t},clear:function(){this.ctx.clearRect(0,0,this.width,this.height);var e=this.canvas.width;this.canvas.width=1,this.canvas.width=e}}}(node.window),function(e,t,n){"use strict";function o(e){this.options=e||{},this.tm=new s,this.init(this.options)}function u(e){e=e||{},this.content="undefined"!=typeof e.content?e.content:"",this.className="undefined"!=typeof e.style?e.style:null}var r=t.document,i=n.JSUS,s=n.TriggerManager;if(!s)throw new Error("HTMLRenderer requires node.TriggerManager to load.");e.HTMLRenderer=o,e.HTMLRenderer.Entity=u,o.prototype.init=function(e){e=e||this.options,this.options=e,this.reset(),e.returnAt&&(this.tm.returnAt=e.returnAt),e.pipeline&&this.tm.initTriggers(e.pipeline)},o.prototype.reset=function(){this.clear(!0),this.addDefaultPipeline()},o.prototype.addDefaultPipeline=function(){this.tm.addTrigger(function(e){return r.createTextNode(e.content)}),this.tm.addTrigger(function(e){if(!e)return;if(e.content&&"object"==typeof e.content){var t=r.createElement("div");for(var n in e.content)if(e.content.hasOwnProperty(n)){var i=n+":	"+e.content[n];t.appendChild(r.createTextNode(i)),t.appendChild(r.createElement("br"))}return t}}),this.tm.addTrigger(function(e){if(!e)return;if(e.content&&e.content.parse&&"function"==typeof e.content.parse){var t=e.content.parse();if(i.isElement(t)||i.isNode(t))return t}}),this.tm.addTrigger(function(e){if(!e)return;if(i.isElement(e.content)||i.isNode(e.content))return e.content})},o.prototype.clear=function(e){return this.tm.clear(e)},o.prototype.addRenderer=function(e,t){return this.tm.addTrigger(e,t)},o.prototype.removeRenderer=function(e){return this.tm.removeTrigger(e)},o.prototype.render=function(e){return this.tm.pullTriggers(e)},o.prototype.size=function(){return this.tm.triggers.length}}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(e,t){"use strict";function o(e,t){e=e||{},this.options=e,r.call(this,e,t),this.id=e.id||"list_"+Math.round(Math.random()*1e3),this.DL=null,this.auto_update=this.options.auto_update||!1,this.htmlRenderer=null,this.lifo=!1,this.init(this.options)}function u(e){s.call(this,e),this.dt="undefined"!=typeof e.dt?e.dt:null,"undefined"!=typeof e.dd&&(this.dd=e.dd)}var n=t.JSUS,r=t.NDDB,i=t.window.HTMLRenderer,s=t.window.HTMLRenderer.Entity;e.List=o,o.prototype=new r,o.prototype.constructor=o,o.prototype.init=function(e){e=e||this.options,this.FIRST_LEVEL=e.first_level||"dl",this.SECOND_LEVEL=e.second_level||"dt",this.THIRD_LEVEL=e.third_level||"dd",this.last_dt=0,this.last_dd=0,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:this.auto_update;var t=this.lifo="undefined"!=typeof e.lifo?e.lifo:this.lifo;this.globalCompare=function(e,n){if(!e&&!n)return 0;if(!n)return 1;if(!e)return-1;if(!t){if(e.dt<n.dt)return-1;if(e.dt>n.dt)return 1}else{if(e.dt<n.dt)return 1;if(e.dt>n.dt)return-1}if(e.dt===n.dt){if("undefined"==typeof e.dd)return-1;if("undefined"==typeof n.dd)return 1;if(e.dd<n.dd)return-1;if(e.dd>n.dd)return 1;if(e.nddbid<n.nddbid)return 1;if(e.nddbid>n.nddbid)return-1}return 0},this.DL=e.list||document.createElement(this.FIRST_LEVEL),this.DL.id=e.id||this.id,e.className&&(this.DL.className=e.className),this.options.title&&this.DL.appendChild(document.createTextNode(e.title)),this.htmlRenderer=new i(e.render)},o.prototype._add=function(e){if(!e)return;this.insert(e),this.auto_update&&this.parse()},o.prototype.addDT=function(e,t){if("undefined"==typeof e)return;this.last_dt++,t="undefined"!=typeof t?t:this.last_dt,this.last_dd=0;var n=new u({dt:t,content:e});return this._add(n)},o.prototype.addDD=function(e,t,n){if("undefined"==typeof e)return;t="undefined"!=typeof t?t:this.last_dt,n="undefined"!=typeof n?n:this.last_dd++;var r=new u({dt:t,dd:n,content:e});return this._add(r)},o.prototype.parse=function(){this.sort();var e=null,t=null,n=function(){var n=document.createElement(this.SECOND_LEVEL);return this.DL.appendChild(n),t=null,e=n,n},r=function(){var e=document.createElement(this.THIRD_LEVEL);return this.DL.appendChild(e),e};if(this.DL){while(this.DL.hasChildNodes())this.DL.removeChild(this.DL.firstChild);this.options.title&&this.DL.appendChild(document.createTextNode(this.options.title))}for(var i=0;i<this.db.length;i++){var s=this.db[i],o;"undefined"==typeof s.dd?o=n.call(this):o=r.call(this);var u=this.htmlRenderer.render(s);o.appendChild(u)}return this.DL},o.prototype.getRoot=function(){return this.DL},u.prototype=new s,u.prototype.constructor=u}("undefined"!=typeof node?"undefined"!=typeof node.window?node.window:node:module.parent.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){"use strict";function a(e,t,n,r,s){if(n&&"number"!=typeof n)throw new TypeError("Table."+e+": x must be number or "+"undefined.");if(r&&"number"!=typeof r)throw new TypeError("Table."+e+": y must be number or "+"undefined.");if(s&&!i.isArray(t))throw new TypeError("Table."+e+": data must be array.");return!0}function f(e){var t,n,r;t=[],n=-1,r=e.length;for(;++n<r;)t.push({content:e[n]});return t}function l(e,t){e=e||{},e.update||(e.update={}),"undefined"==typeof e.update.indexes&&(e.update.indexes=!0),s.call(this,e,t),this.rowcol||this.index("rowcol",function(e){return e.x+"_"+e.y}),this.pointers={x:e.pointerX||null,y:e.pointerY||null},this.header=[],this.footer=[],this.left=[],this.table=e.table||r.createElement("table"),"undefined"!=typeof e.id&&(this.table.id=e.id),"undefined"!=typeof e.className&&(this.table.className=e.className),this.missingClassName=e.missingClassName||"missing",this.autoParse="undefined"!=typeof e.autoParse?e.autoParse:!1,this.initRenderer(e.render)}function c(e){u.call(this,e),this.x="undefined"!=typeof e.x?e.x:null,this.y="undefined"!=typeof e.y?e.y:null,this.HTMLElement=e.HTMLElement||null}var r=t.document;e.Table=l,e.Table.Cell=c;var i=n.JSUS,s=n.NDDB,o=n.window.HTMLRenderer,u=n.window.HTMLRenderer.Entity;l.prototype=new s,l.prototype.constructor=l,l.prototype.addClass=function(e){if("string"!=typeof e&&!i.isArray(e))throw new TypeError("Table.addClass: className must be string or array.");return i.isArray(e)&&(e=e.join(" ")),this.each(function(t){W.addClass(t,e),t.HTMLElement&&(t.HTMLElement.className=t.className)}),this},l.prototype.removeClass=function(e){var t;if("string"!=typeof e&&!i.isArray(e))throw new TypeError("Table.removeClass: className must be string or array.");return i.isArray(e)?t=function(e,t){for(var n=0;n<t.length;n++)W.removeClass(e,t[n])}:t=W.removeClass,this.each(function(n){t.call(this,n,e),n.HTMLElement&&(n.HTMLElement.className=n.className)}),this},l.prototype.initRenderer=function(e){e=e||{},this.htmlRenderer=new o(e),this.htmlRenderer.addRenderer(function(e){var t,n;if("object"==typeof e.content){t=new l;for(n in e.content)e.content.hasOwnProperty(n)&&t.addRow([n,e.content[n]]);return t.parse()}},2)},l.prototype.renderCell=function(e,t){var n,i;if(!e)return;return t=t||"td",n=r.createElement(t),i=this.htmlRenderer.render(e),n.appendChild(i),e.className&&(n.className=e.className),e.HTMLElement=n,n},l.prototype.get=function(e,t){if("undefined"!=typeof e&&"number"!=typeof e)throw new TypeError("Table.get: row must be number.");if("undefined"!=typeof t&&"number"!=typeof t)throw new TypeError("Table.get: col must be number.");return"undefined"==typeof e?this.select("y","=",t):"undefined"==typeof t?this.select("x","=",e):this.rowcol.get(e+"_"+t)},l.prototype.getTR=function(e){var t;if("number"!=typeof e)throw new TypeError("Table.getTr: row must be number.");return t=this.get(e,0),t?t.HTMLElement?t.HTMLElement.parentNode:!1:!1},l.prototype.setHeader=function(e){if(!a("setHeader",e,null,null,!0))return;this.header=f(e)},l.prototype.setLeft=function(e){if(!a("setLeft",e,null,null,!0))return;this.left=f(e)},l.prototype.setFooter=function(e){if(!a("setFooter",e,null,null,!0))return;this.footer=f(e)},l.prototype.updatePointer=function(e,t){if("undefined"==typeof this.pointers[e])return n.err("Table.updatePointer: invalid pointer: "+e),!1;if(this.pointers[e]===null||t>this.pointers[e])this.pointers[e]=t;return this.pointers[e]},l.prototype.addMultiple=function(e,t,n,r){var s,o,u,f;if(!a("addMultiple",e,n,r))return;if(t&&"string"!=typeof t||t&&"undefined"==typeof this.pointers[t])throw new TypeError("Table.addMultiple: dim must be a valid string (x, y) or undefined.");t=t||"x",n=this.getCurrPointer("x",n),r=this.getNextPointer("y",r),n="undefined"!=typeof n?n:this.pointers.x===null?0:this.pointers.x,r="undefined"!=typeof r?r:this.pointers.y===null?0:this.pointers.y,i.isArray(e)||(e=[e]),s=-1,o=e.length;for(;++s<o;)if(!i.isArray(e[s]))t==="x"?this.add(e[s],n,r+s,"x"):this.add(e[s],n+s,r,"y");else{u=-1,f=e[s].length;for(;++u<f;)t==="x"?this.add(e[s][u],n+s,r+u,"x"):this.add(e[s][u],n+u,r+s,"y")}this.autoParse&&this.parse()},l.prototype.add=function(e,t,n,r){var i;if(!a("addData",e,t,n))return;if(r&&"string"!=typeof r||r&&"undefined"==typeof this.pointers[r])throw new TypeError("Table.add: dim must be a valid string (x, y) or undefined.");r=r||"x",t=r==="y"?this.getCurrPointer("x",t):this.getNextPointer("x",t),n=r==="y"?this.getNextPointer("y",n):this.getCurrPointer("y",n),i=new c({x:t,y:n,content:e}),this.insert(i),this.updatePointer("x",t),this.updatePointer("y",n)},l.prototype.addColumn=function(e,t,n){if(!a("addColumn",e,t,n))return;return this.addMultiple(e,"y",t||0,this.getNextPointer("y",n))},l.prototype.addRow=function(e,t,n){if(!a("addRow",e,t,n))return;return this.addMultiple(e,"x",this.getNextPointer("x",t),n||0)},l.prototype.getNextPointer=function(e,t){return"undefined"!=typeof t?t:this.pointers[e]===null?0:this.pointers[e]+1},l.prototype.getCurrPointer=function(e,t){return"undefined"!=typeof t?t:this.pointers[e]===null?0:this.pointers[e]},l.prototype.parse=function(){var e,t,n,i,s,o,u,a,f,l,c,h,p,d;this.table&&this.table.children&&(this.table.innerHTML=""),e=this.table;if(this.header&&this.header.length){i=r.createElement("thead"),t=r.createElement("tr"),this.left&&this.left.length&&t.appendChild(r.createElement("th")),u=-1,f=this.header.length;for(;++u<f;)t.appendChild(this.renderCell(this.header[u],"th"));i.appendChild(t),e.appendChild(i)}if(this.size()){s=r.createElement("tbody"),this.sort(["x","y"]),l=-1,c=this.first(),h=c.y,p=0,u=-1,f=this.db.length;for(;++u<f;){l!==this.db[u].x&&(t=r.createElement("tr"),s.appendChild(t),l=this.db[u].x,h=c.y-1,this.left&&this.left.length&&(n=r.createElement("td"),t.appendChild(this.renderCell(this.left[p])),p++));if(this.db[u].y>h+1){d=this.db[u].y-(h+1);for(a=0;a<d;a++)n=r.createElement("td"),n.className=this.missingClassName,t.appendChild(n)}t.appendChild(this.renderCell(this.db[u])),h=this.db[u].y}e.appendChild(s)}if(this.footer&&this.footer.length){o=r.createElement("tfoot"),t=r.createElement("tr"),this.header&&this.header.length&&(n=r.createElement("td"),t.appendChild(n)),u=-1,f=this.footer.length;for(;++u<f;)t.appendChild(this.renderCell(this.footer[u]));o.appendChild(t),e.appendChild(o)}return e},l.prototype.resetPointers=function(e){if(e&&"object"!=typeof e)throw new TypeError("Table.resetPointers: pointers must be object or undefined.");e=e||{},this.pointers={x:e.pointerX||0,y:e.pointerY||0}},l.prototype.clear=function(e){s.prototype.clear.call(this,e)&&this.resetPointers()},c.prototype=new u,c.prototype.constructor=c}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node)
