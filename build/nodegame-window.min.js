/**
 * # GameWindow
 * Copyright(c) 2014 Stefano Balietti
 * MIT Licensed
 *
 * GameWindow provides a handy API to interface nodeGame with the
 * browser window.
 *
 * Creates a custom root element inside the HTML page, and insert an
 * iframe element inside it.
 *
 * Dynamic content can be loaded inside the iframe without losing the
 * javascript state inside the page.
 *
 * Defines a number of profiles associated with special page layout.
 *
 * Depends on JSUS and nodegame-client.
 * ---
 */
(function(e,t){"use strict";function a(e,t){function r(i){e.removeEventListener("load",r,!1),n.removeEventListener("load",r,!1),t&&setTimeout(function(){t()},120)}var n;n=e.contentWindow,e.addEventListener("load",r,!1),n.addEventListener("load",r,!1)}function f(e,t){function r(i){var s;s=JSUS.getIFrameDocument(e);if(i.type==="load"||s.readyState==="complete")e.detachEvent("onreadystatechange",r),n.detachEvent("onload",r),t&&setTimeout(function(){t()},120)}var n;n=e.contentWindow,e.attachEvent("onreadystatechange",r),n.attachEvent("onload",r)}function l(e,t){e.attachEvent?f(e,t):a(e,t)}function c(){this.setStateLevel("UNINITIALIZED");if("undefined"==typeof e)throw new Error("GameWindow: no window found. Are you in a browser?");if("undefined"==typeof t)throw new Error("GameWindow: nodeGame not found");t.log("node-window: loading..."),this.frameName=null,this.frameElement=null,this.frameWindow=null,this.frameDocument=null,this.frameRoot=null,this.headerElement=null,this.headerName=null,this.headerRoot=null,this.headerPosition=null,this.defaultHeaderPosition="left",this.conf={},this.areLoading=0,this.cacheSupported=null,this.cache={},this.currentURIs={},this.globalLibs=[],this.frameLibs={},this.state=null,this.waitScreen=null,this.screenState=t.constants.screenLevels.ACTIVE,this.textOnleave=null,t.registerSetup("window",function(e){return e=e||{},"undefined"==typeof e.promptOnleave&&(e.promptOnleave=!1),"undefined"==typeof e.noEscape&&(e.noEscape=!0),this.window.init(e),e}),this.init()}function h(e,t,n,r,i,s){var o;o=W.getIFrameDocument(n).documentElement,i&&(o.innerHTML=e.cache[t].contents),r===e.frameName&&(e.frameWindow=n.contentWindow,e.frameDocument=e.getIFrameDocument(n)),p(n),i&&d(n),v(n,e.globalLibs.concat(e.frameLibs.hasOwnProperty(t)?e.frameLibs[t]:[])),s&&(e.cache[t].contents=o.innerHTML)}function p(e){var t,n,r,i;n=W.getIFrameDocument(e),r=W.getElementsByClassName(n,"injectedlib","script");for(t=0;t<r.length;t++)i=r[t],i.parentNode.removeChild(i)}function d(e){var t,n,r,i,s,o,u,a;t=W.getIFrameDocument(e),n=W.getIFrameAnyChild(e),i=t.getElementsByTagName("script");for(s=0;s<i.length;s++){r=i[s],r.parentNode.removeChild(r),o=document.createElement("script"),r.innerHTML&&(o.innerHTML=r.innerHTML);for(u=0;u<r.attributes.length;u++)a=r.attributes[u],o.setAttribute(a.name,a.value);n.appendChild(o)}}function v(e,t){var n,r,i,s,o;n=W.getIFrameDocument(e),r=W.getIFrameAnyChild(e);for(s=0;s<t.length;s++)o=t[s],i=document.createElement("script"),i.className="injectedlib",i.src=o,r.appendChild(i)}function m(e,t){u?setTimeout(function(){m.call(e,t)},300):(u=!0,e.areLoading=e.areLoading+t,u=!1)}function g(e,t){var n;if(!e.frameElement)throw new Error("adaptFrame2HeaderPosition: frame not found.");n=e.headerPosition||"top",t==="bottom"&&n!=="bottom"&&e.getFrameRoot().insertBefore(e.headerElement,e.frameElement),e.removeClass(e.frameElement,"ng_mainframe-header-[a-z-]*");switch(n){case"right":case"left":e.addClass(e.frameElement,"ng_mainframe-header-vertical");break;case"top":e.addClass(e.frameElement,"ng_mainframe-header-horizontal"),e.headerElement&&e.getFrameRoot().insertBefore(e.headerElement,e.frameElement);break;case"bottom":e.addClass(e.frameElement,"ng_mainframe-header-horizontal"),e.headerElement&&e.getFrameRoot().insertBefore(e.headerElement,e.frameElement.nextSibling)}}var n=t.JSUS;if(!n)throw new Error("GameWindow: JSUS object not found. Aborting");var r=n.get("DOM");if(!r)throw new Error("GameWindow: JSUS DOM object not found. Aborting.");var i=t.constants,s=i.windowLevels,o=i.screenLevels,u=!1;c.prototype=r,c.prototype.constructor=c,c.defaults={},c.defaults.promptOnleave=!0,c.defaults.noEscape=!0,c.defaults.cacheDefaults={loadCache:!0,storeCacheNow:!1,storeCacheLater:!1},c.prototype.init=function(e){this.setStateLevel("INITIALIZING"),e=e||{},this.conf=n.merge(c.defaults,e),this.conf.textOnleave&&(this.textOnleave=this.conf.textOnleave),this.conf.promptOnleave?this.promptOnleave():this.conf.promptOnleave===!1&&this.restoreOnleave(),this.conf.noEscape?this.noEscape():this.conf.noEscape===!1&&this.restoreEscape(),this.conf.waitScreen!==!1?(this.waitScreen&&(this.waitScreen.destroy(),this.waitScreen=null),this.waitScreen=new t.WaitScreen(this.conf.waitScreen)):this.waitScreen&&(this.waitScreen.destroy(),this.waitScreen=null),this.setStateLevel("INITIALIZED")},c.prototype.reset=function(){this.isScreenLocked()&&this.unlockScreen(),t.widgets&&t.widgets.destroyAll(),this.getFrame()&&this.destroyFrame(),this.getHeader()&&this.destroyHeader(),this.areLoading=0,this.clearCache()},c.prototype.setStateLevel=function(e){if("string"!=typeof e)throw new TypeError("GameWindow.setStateLevel: level must be string.");if("undefined"==typeof s[e])throw new Error("GameWindow.setStateLevel: unrecognized level: "+e+".");this.state=s[e]},c.prototype.getStateLevel=function(){return this.state},c.prototype.isReady=function(){return this.state===s.INITIALIZED||this.state===s.LOADED},c.prototype.setScreenLevel=function(e){if("string"!=typeof e)throw new TypeError("GameWindow.setScreenLevel: level must be string.");if("undefined"==typeof o[e])throw new Error("GameWindow.setScreenLevel: unrecognized level: "+e+".");this.screenState=o[e]},c.prototype.getScreenLevel=function(){return this.screenState},c.prototype.getFrame=function(){return this.frameElement||this.frameName&&(this.frameElement=document.getElementById(this.frameName)),this.frameElement},c.prototype.getFrameName=function(){var e;return this.frameName||(e=this.getFrame(),this.frameName=e?e.name||e.id:null),this.frameName},c.prototype.getFrameWindow=function(){var e;return this.frameWindow||(e=this.getFrame(),this.frameWindow=e?e.contentWindow:null),this.frameWindow},c.prototype.getFrameDocument=function(){var e;return this.frameDocument||(e=this.getFrame(),this.frameDocument=e?this.getIFrameDocument(e):null),this.frameDocument},c.prototype.getFrameRoot=function(){var e;return this.frameRoot||(e=this.getFrame(),this.frameRoot=e?e.parentNode:null),this.frameRoot},c.prototype.generateFrame=function(e,t,r){var i;if(!r&&this.frameElement)throw new Error("GameWindow.generateFrame: a frame element is already existing. It cannot be duplicated.");e=e||this.frameRoot||document.body;if(!n.isElement(e))throw new Error("GameWindow.generateFrame: invalid root element.");t=t||"ng_mainframe";if("string"!=typeof t)throw new Error("GameWindow.generateFrame: frameName must be string.");if(document.getElementById(t))throw new Error("GameWindow.generateFrame: frameName must be unique.");return i=W.addIFrame(e,t),i.contentWindow.location.replace("about:blank"),this.setFrame(i,t,e),this.frameElement&&g(this),i},c.prototype.setFrame=function(e,t,r){if(!n.isElement(e))throw new Error("GameWindow.setFrame: iframe must be HTMLElement.");if("string"!=typeof t)throw new Error("GameWindow.setFrame: iframeName must be string.");if(!n.isElement(r))throw new Error("GameWindow.setFrame: invalid root element.");return this.frameRoot=r,this.frameName=t,this.frameElement=e,this.frameWindow=e.contentWindow,this.frameDocument=W.getIFrameDocument(e),e},c.prototype.destroyFrame=function(){this.clearFrame(),this.frameRoot.removeChild(this.frameElement),this.frameElement=null,this.frameWindow=null,this.frameDocument=null,this.frameRoot=null},c.prototype.clearFrame=function(){var t,n;t=this.getFrame();if(!t)throw new Error("GameWindow.clearFrame: cannot detect frame.");n=t.name||t.id,t.onload=null,t.contentWindow.location.replace("about:blank"),this.frameElement=t,this.frameWindow=e.frames[n],this.frameDocument=W.getIFrameDocument(t)},c.prototype.generateHeader=function(e,t,r){var i;if(!r&&this.headerElement)throw new Error("GameWindow.generateHeader: a header element is already existing. It cannot be duplicated.");e=e||document.body||document.lastElementChild;if(!n.isElement(e))throw new Error("GameWindow.generateHeader: invalid root element.");t=t||"ng_header";if("string"!=typeof t)throw new Error("GameWindow.generateHeader: headerName must be string.");if(document.getElementById(t))throw new Error("GameWindow.generateHeader: headerName must be unique.");return i=this.addElement("div",e,t),this.frameElement&&this.defaultHeaderPosition!=="bottom"&&this.getFrameRoot().insertBefore(i,this.frameElement),this.setHeader(i,t,e),this.setHeaderPosition(this.defaultHeaderPosition),i},c.prototype.setHeaderPosition=function(e){var n,r,i;if("string"!=typeof e)throw new TypeError("GameWindow.setHeaderPosition: position must be string.");r=e.toLowerCase();if(this.headerPosition===r)return;n={top:"ng_header_position-horizontal-t",bottom:"ng_header_position-horizontal-b",right:"ng_header_position-vertical-r",left:"ng_header_position-vertical-l"};if("undefined"==typeof n[r]){t.err("GameWindow.setHeaderPosition: invalid header position: "+r+".");return}if(!this.headerElement)throw new Error("GameWindow.setHeaderPosition: headerElement not found.");W.removeClass(this.headerElement,"ng_header_position-[a-z-]*"),W.addClass(this.headerElement,n[r]),i=this.headerPosition,this.headerPosition=r,this.frameElement&&g(this,i)},c.prototype.setHeader=function(e,t,r){if(!n.isElement(e))throw new Error("GameWindow.setHeader: header must be HTMLElement.");if("string"!=typeof t)throw new Error("GameWindow.setHeader: headerName must be string.");if(!n.isElement(r))throw new Error("GameWindow.setHeader: invalid root element.");return this.headerElement=e,this.headerName=t,this.headerRoot=r,this.headerElement},c.prototype.getHeader=function(){return this.headerElement||(this.headerElement=this.headerName?document.getElementById(this.headerName):null),this.headerElement},c.prototype.getHeaderName=function(){var e;return this.headerName||(e=this.getHeader(),this.headerName=e?e.id:null),this.headerName},c.prototype.getHeaderRoot=function(){var e;return this.headerRoot||(e=this.getHeader(),this.headerRoot=e?e.parentNode:null),this.headerRoot},c.prototype.destroyHeader=function(){this.clearHeader(),this.headerRoot.removeChild(this.headerElement),this.headerElement=null,this.headerName=null,this.headerRoot=null},c.prototype.clearHeader=function(){var e;e=this.getHeader();if(!e)throw new Error("GameWindow.clearHeader: cannot detect header.");this.headerElement.innerHTML=""},c.prototype.setupFrame=function(e){if("string"!=typeof e)throw new TypeError("GameWindow.setup: profile must be string.");switch(e){case"MONITOR":this.getFrame()||this.generateFrame(),t.widgets.append("NextPreviousState"),t.widgets.append("GameSummary"),t.widgets.append("StateDisplay"),t.widgets.append("StateBar"),t.widgets.append("DataBar"),t.widgets.append("MsgBar"),t.widgets.append("GameBoard"),t.widgets.append("ServerInfoDisplay"),t.widgets.append("Wall"),t.conf.host&&this.addCSS(this.getFrameRoot(),t.conf.host+"/stylesheets/monitor.css");break;case"PLAYER":this.generateHeader(),t.game.visualState=t.widgets.append("VisualState",this.headerElement),t.game.timer=t.widgets.append("VisualTimer",this.headerElement),t.game.stateDisplay=t.widgets.append("StateDisplay",this.headerElement);case"SOLO_PLAYER":this.getFrame()||this.generateFrame(),t.conf.host&&this.addCSS(this.getFrameRoot(),t.conf.host+"/stylesheets/nodegame.css");break;default:throw new Error("GameWindow.setupFrame: unknown profile type: "+e+".")}},c.prototype.initLibs=function(e,t){this.globalLibs=e||[],this.frameLibs=t||{}},c.prototype.preCacheTest=function(e,t){var n,r;t=t||"/pages/testpage.htm";if("string"!=typeof t)throw new TypeError("GameWindow.precacheTest: uri must string or undefined.");n=document.createElement("iframe"),n.style.display="none",r="preCacheTest",n.id=r,n.name=r,document.body.appendChild(n),n.contentWindow.location.replace(t),l(n,function(){try{W.getIFrameDocument(n).documentElement.innerHTML="a",W.cacheSupported=!0}catch(t){W.cacheSupported=!1}document.body.removeChild(n),e&&e()})},c.prototype.preCache=function(r,i){var s,o,u,a,f,c;"string"==typeof r&&(r=[r]);if(!n.isArray(r))throw new TypeError("GameWindow.preCache: uris must be string or array.");if(i&&"function"!=typeof i)throw new TypeError("GameWindow.preCache: callback must be function or undefined.");if(!r.length){i&&i();return}s=this;if(this.cacheSupported===null){this.preCacheTest(function(){s.preCache(r,i)});return}if(this.cacheSupported===!1){t.warn("GameWindow.preCache: caching is not supported by your browser."),i&&i();return}o=0;for(a=0;a<r.length;a++)u=r[a],f=document.createElement("iframe"),f.style.display="none",c="tmp_iframe_"+a,f.id=c,f.name=c,document.body.appendChild(f),function(e,t){l(t,function(){var n,u;n=W.getIFrameDocument(t),u=n.documentElement,s.cache[e]={contents:u.innerHTML,cacheOnClose:!1},document.body.removeChild(t),o++,o>=r.length&&i&&i()})}(u,f),e.frames[c].location.replace(u)},c.prototype.clearCache=function(){this.cache={}},c.prototype.getElementById=function(e){var t,n;return n=this.getFrameDocument(),t=null,n&&n.getElementById&&(t=n.getElementById(e)),t||(t=document.getElementById(e)),t},c.prototype.getElementsByTagName=function(e){var t;return t=this.getFrameDocument(),t?t.getElementsByTagName(e):document.getElementsByTagName(e)},c.prototype.loadFrame=function(e,n,r){var i,s,o,u,a,f,p,d,v,g,y;if("string"!=typeof e)throw new TypeError("GameWindow.loadFrame: uri must be string.");if(n&&"function"!=typeof n)throw new TypeError("GameWindow.loadFrame: func must be function or undefined.");if(r&&"object"!=typeof r)throw new TypeError("GameWindow.loadFrame: opts must be object or undefined.");r=r||{},a=this.getFrame(),f=this.frameName;if(!a)throw new Error("GameWindow.loadFrame: no frame found.");if(!f)throw new Error("GameWindow.loadFrame: frame has no name.");this.setStateLevel("LOADING"),i=this,d=a.contentWindow,p=W.getIFrameDocument(a),g=p.readyState,g=g==="interactive"||g==="complete",s=c.defaults.cacheDefaults.loadCache,o=c.defaults.cacheDefaults.storeCacheNow,u=c.defaults.cacheDefaults.storeCacheLater;if(r.cache){if(r.cache.loadMode)if(r.cache.loadMode==="reload")s=!1;else{if(r.cache.loadMode!=="cache")throw new Error("GameWindow.loadFrame: unkown cache load mode: "+r.cache.loadMode+".");s=!0}if(r.cache.storeMode)if(r.cache.storeMode==="off")o=!1,u=!1;else if(r.cache.storeMode==="onLoad")o=!0,u=!1;else{if(r.cache.storeMode!=="onClose")throw new Error("GameWindow.loadFrame: unkown cache store mode: "+r.cache.storeMode+".");o=!1,u=!0}}if(this.cacheSupported===null){this.preCacheTest(function(){i.loadFrame(e,n,r)});return}this.cacheSupported===!1?(o=!1,u=!1,s=!1):(y=this.currentURIs[f],this.cache.hasOwnProperty(y)&&this.cache[y].cacheOnClose&&(v=p.documentElement,this.cache[y].contents=v.innerHTML),this.cache.hasOwnProperty(e)||(this.cache[e]={contents:null,cacheOnClose:!1}),this.cache[e].cacheOnClose=u,this.cache[e].contents===null&&(s=!1)),this.currentURIs[f]=e,m(this,1),(!s||!g)&&l(a,function(){h(i,e,a,f,s,o),i.updateLoadFrameState(n)}),s?g&&(h(this,e,a,f,s,o),this.updateLoadFrameState(n)):d.location.replace(e),d.node=t},c.prototype.updateLoadFrameState=function(e){e&&e.call(t.game),m(this,-1),this.areLoading===0?(this.setStateLevel("LOADED"),t.emit("WINDOW_LOADED")):t.silly("GameWindow.updateLoadFrameState: "+this.areLoading+" loadFrame processes open.")},t.GameWindow=c})("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";var n=t.GameWindow;n.prototype.noEscape=function(t){t=t||e,t.document.onkeydown=function(t){var n=e.event?event.keyCode:t.keyCode;if(n===27)return!1}},n.prototype.restoreEscape=function(t){t=t||e,t.document.onkeydown=null},n.prototype.promptOnleave=function(t,n){t=t||e,n="undefined"!=typeof n?n:this.textOnleave,t.onbeforeunload=function(t){return t=t||e.event,t&&(t.returnValue=n),n}},n.prototype.restoreOnleave=function(t){t=t||e,t.onbeforeunload=null}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";var n=t.JSUS,r=t.GameWindow,i=t.constants.screenLevels;r.prototype.lockScreen=function(e){var t;t=this;if(!this.waitScreen)throw new Error("GameWindow.lockScreen: waitScreen not found.");if(e&&"string"!=typeof e)throw new TypeError("GameWindow.lockScreen: text must be string or undefined");this.isReady()||setTimeout(function(){t.lockScreen(e)},100),this.setScreenLevel("LOCKING"),e=e||"Screen locked. Please wait...",this.waitScreen.lock(e),this.setScreenLevel("LOCKED")},r.prototype.unlockScreen=function(){if(!this.waitScreen)throw new Error("GameWindow.unlockScreen: waitScreen not found.");if(!this.isScreenLocked())throw new Error("GameWindow.unlockScreen: screen is not locked.");this.setScreenLevel("UNLOCKING"),this.waitScreen.unlock(),this.setScreenLevel("ACTIVE")},r.prototype.isScreenLocked=function(){return this.getScreenLevel()!==i.ACTIVE}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e){"use strict";function t(e,t){var n;if("string"==typeof e){n=W.getElementById(e);if(!n)throw new Error(t+": could not find element "+"with id "+e)}else{if(!JSUS.isElement(e))throw new TypeError(t+": idOrObj must be string "+" or HTML Element.");n=e}return n}e.on("NODEGAME_GAME_CREATED",function(){W.init(e.conf.window)}),e.on("HIDE",function(e){var n=t(e,"GameWindow.on.HIDE");n.style.display="none"}),e.on("SHOW",function(e){var n=t(e,"GameWindow.on.SHOW");n.style.display=""}),e.on("TOGGLE",function(e){var n=t(e,"GameWindow.on.TOGGLE");n.style.display==="none"?n.style.display="":n.style.display="none"}),e.on("INPUT_DISABLE",function(e){W.toggleInputs(e,!0)}),e.on("INPUT_ENABLE",function(e){W.toggleInputs(e,!1)}),e.on("INPUT_TOGGLE",function(e){W.toggleInputs(e)}),e.log("node-window: listeners added.")}("undefined"!=typeof node?node:undefined),function(e,t){"use strict";function n(e){e=e||W.waitScreen.text.waiting,W.isScreenLocked()?W.waitScreen.updateText(e):W.lockScreen(e)}function r(e){e=e||W.waitScreen.text.stepping,W.isScreenLocked()?W.waitScreen.updateText(e):W.lockScreen(e)}function i(){W.isScreenLocked()&&W.unlockScreen()}function s(e){e=e||W.waitScreen.text.paused,W.lockScreen(e)}function o(){W.isScreenLocked()&&W.unlockScreen()}function u(e){e=e||{},this.id=e.id||"ng_waitScreen",this.root=e.root||null,this.text={waiting:e.waitingText||"Waiting for other players to be done...",stepping:e.steppingText||"Initializing game step, will be ready soon...",paused:e.pausedText||"Game is paused. Please wait."},this.waitingDiv=null,this.enable()}e.WaitScreen=u,u.version="0.7.0",u.description="Show a standard waiting screen",u.prototype.lock=function(e){this.waitingDiv||(this.root||(this.root=W.getFrameRoot()||document.body),this.waitingDiv=W.addDiv(this.root,this.id)),this.waitingDiv.style.display==="none"&&(this.waitingDiv.style.display=""),this.waitingDiv.innerHTML=e},u.prototype.unlock=function(){this.waitingDiv&&this.waitingDiv.style.display===""&&(this.waitingDiv.style.display="none")},u.prototype.updateText=function(e,t){t=t||!1;if("string"!=typeof e)throw new TypeError("WaitScreen.updateText: text must be string.");t?this.waitingDiv.appendChild(document.createTextNode(e)):this.waitingDiv.innerHTML=e},u.prototype.enable=function(e){e===!1||e===null?(node.off("REALLY_DONE",n),node.off("STEPPING",r),node.off("PLAYING",i),node.off("RESUMED",s),node.off("RESUMED",o)):(node.on("REALLY_DONE",n),node.on("STEPPING",r),node.on("PLAYING",i),node.on("RESUMED",s),node.on("RESUMED",o))},u.prototype.destroy=function(){W.isScreenLocked()&&this.unlock(),this.waitingDiv&&this.waitingDiv.parentNode.removeChild(this.waitingDiv)}}("undefined"!=typeof node?node:module.parent.exports.node,"undefined"!=typeof window?window:module.parent.exports.window),function(e,t){"use strict";var n=t.JSUS,r=t.constants,i=t.GameWindow;i.prototype.getRecipientSelector=function(e){var t;return t=document.createElement("select"),"undefined"!=typeof e&&(t.id=e),this.addStandardRecipients(t),t},i.prototype.addRecipientSelector=function(e,t){var n;return e?(n=this.getRecipientSelector(t),e.appendChild(n)):!1},i.prototype.addStandardRecipients=function(e){var t;t=document.createElement("option"),t.value="ALL",t.appendChild(document.createTextNode("ALL")),e.appendChild(t),t=document.createElement("option"),t.value="CHANNEL",t.appendChild(document.createTextNode("CHANNEL")),e.appendChild(t),t=document.createElement("option"),t.value="ROOM",t.appendChild(document.createTextNode("ROOM")),e.appendChild(t),t=document.createElement("option"),t.value="SERVER",t.appendChild(document.createTextNode("SERVER")),e.appendChild(t)},i.prototype.populateRecipientSelector=function(e,t){var r,i;if("object"!=typeof t||"object"!=typeof e)return;this.removeChildrenFromNode(e),this.addStandardRecipients(e),r=t.db||t,n.each(r,function(t){i=document.createElement("option"),i.value=t.id,i.appendChild(document.createTextNode(t.name||t.id)),e.appendChild(i)})},i.prototype.getActionSelector=function(e){var t=document.createElement("select");return"undefined"!=typeof e&&(t.id=e),this.populateSelect(t,r.action),t},i.prototype.addActionSelector=function(e,t){var n;if(!e)return;return n=this.getActionSelector(t),e.appendChild(n)},i.prototype.getTargetSelector=function(e){var t;return t=document.createElement("select"),"undefined"!=typeof e&&(t.id=e),this.populateSelect(t,r.target),t},i.prototype.addTargetSelector=function(e,t){if(!e)return;var n=this.getTargetSelector(t);return e.appendChild(n)},i.prototype.getStateSelector=function(e){return this.getTextInput(e)},i.prototype.addStateSelector=function(e,t){var n;if(!e)return;return n=this.getStateSelector(t),e.appendChild(n)}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";var n=t.GameWindow,r=t.JSUS,i=r.get("DOM");n.prototype.getScreen=function(){var e=this.getFrameDocument();return e?e=e.body||e:e=document.body||document.lastElementChild,e},n.prototype.write=function(e,t){"string"==typeof t?t=this.getElementById(t):t||(t=this.getScreen());if(!t)throw new Error("GameWindow.write: could not determine where to write.");return i.write(t,e)},n.prototype.writeln=function(e,t,n){"string"==typeof t?t=this.getElementById(t):t||(t=this.getScreen());if(!t)throw new Error("GameWindow.writeln: could not determine where to write.");return i.writeln(t,e,n)},n.prototype.generateUniqueId=function(e){var t,n;t=""+(e||r.randomInt(0,1e3)),n=this.getElementById(t);while(n)t=""+e+"_"+r.randomInt(0,1e3),n=this.getElementById(t);return t},n.prototype.toggleInputs=function(e,t){var n,r,i,s,o,u,a;if("undefined"!=typeof e){n=this.getElementById(e);if(!n)throw new Error("GameWindow.toggleInputs: no elements found with id "+e+".")}else{n=this.getFrameDocument();if(!n||!n.getElementsByTagName)return}r=["button","select","textarea","input"],s=r.length;for(i=0;i<s;i++){u=n.getElementsByTagName(r[i]),a=u.length;for(o=0;o<a;o++)"undefined"==typeof t&&(t=u[o].disabled?!1:!0),t?u[o].disabled=t:u[o].removeAttribute("disabled")}},n.prototype.getScreenInfo=function(){var t=e.screen;return{height:t.height,widht:t.width,availHeight:t.availHeight,availWidth:t.availWidht,colorDepth:t.colorDepth,pixelDepth:t.pixedDepth}},n.prototype.getLoadingDots=function(e,t){function o(){n.innerHTML=".",clearInterval(s)}var n,r,i,s;if(e&e<0)throw new Error("GameWindow.getLoadingDots: len < 0.");e=e||5,n=document.createElement("span"),n.id=t||"span_dots",i="";for(r=0;r<e;r++)i+=".";return s=setInterval(function(){n.innerHTML!==i?n.innerHTML=n.innerHTML+".":n.innerHTML="."},1e3),{span:n,stop:o}},n.prototype.addLoadingDots=function(e,t,n){return e.appendChild(this.getLoadingDots(t,n).span)},n.prototype.getEventButton=function(e,n,r,i){var s;if("string"!=typeof e)throw new TypeError("GameWindow.getEventButton: event must be string.");return s=this.getButton(r,n,i),s.onclick=function(){t.emit(e)},s},n.prototype.addEventButton=function(e,t,n,r,i){var s;if(!e)return;return n||(n=this.getScreen()),s=this.getEventButton(e,t,r,i),n.appendChild(s)}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(){"use strict";node.window=new node.GameWindow,"undefined"!=typeof window&&(window.W=node.window)}(),function(e){"use strict";function t(e){this.canvas=e,this.ctx=e.getContext("2d"),this.centerX=e.width/2,this.centerY=e.height/2,this.width=e.width,this.height=e.height}e.Canvas=t,t.prototype={constructor:t,drawOval:function(e){var t=e.x/e.scale_x,n=e.y/e.scale_y,r=e.radius||100;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.scale(e.scale_x,e.scale_y),this.ctx.beginPath(),this.ctx.arc(t,n,r,0,Math.PI*2,!1),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},drawLine:function(e){var t=e.x,n=e.y,r=e.length,i=e.angle,s=-Math.cos(i)*r+e.x,o=Math.sin(i)*r+e.y;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(t,n),this.ctx.lineTo(s,o),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},scale:function(e,t){this.ctx.scale(e,t),this.centerX=this.canvas.width/2/e,this.centerY=this.canvas.height/2/t},clear:function(){this.ctx.clearRect(0,0,this.width,this.height);var e=this.canvas.width;this.canvas.width=1,this.canvas.width=e}}}(node.window),function(e,t,n){"use strict";function o(e){this.options=e||{},this.tm=new s,this.init(this.options)}function u(e){e=e||{},this.content="undefined"!=typeof e.content?e.content:"",this.className="undefined"!=typeof e.style?e.style:null}var r=t.document,i=n.JSUS,s=n.TriggerManager;if(!s)throw new Error("HTMLRenderer requires node.TriggerManager to load.");e.HTMLRenderer=o,e.HTMLRenderer.Entity=u,o.prototype.init=function(e){e=e||this.options,this.options=e,this.reset(),e.returnAt&&(this.tm.returnAt=e.returnAt),e.pipeline&&this.tm.initTriggers(e.pipeline)},o.prototype.reset=function(){this.clear(!0),this.addDefaultPipeline()},o.prototype.addDefaultPipeline=function(){this.tm.addTrigger(function(e){return r.createTextNode(e.content)}),this.tm.addTrigger(function(e){if(!e)return;if(e.content&&"object"==typeof e.content){var t=r.createElement("div");for(var n in e.content)if(e.content.hasOwnProperty(n)){var i=n+":	"+e.content[n];t.appendChild(r.createTextNode(i)),t.appendChild(r.createElement("br"))}return t}}),this.tm.addTrigger(function(e){if(!e)return;if(e.content&&e.content.parse&&"function"==typeof e.content.parse){var t=e.content.parse();if(i.isElement(t)||i.isNode(t))return t}}),this.tm.addTrigger(function(e){if(!e)return;if(i.isElement(e.content)||i.isNode(e.content))return e.content})},o.prototype.clear=function(e){return this.tm.clear(e)},o.prototype.addRenderer=function(e,t){return this.tm.addTrigger(e,t)},o.prototype.removeRenderer=function(e){return this.tm.removeTrigger(e)},o.prototype.render=function(e){return this.tm.pullTriggers(e)},o.prototype.size=function(){return this.tm.triggers.length}}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(e,t){"use strict";function o(e,t){e=e||{},this.options=e,r.call(this,e,t),this.id=e.id||"list_"+Math.round(Math.random()*1e3),this.DL=null,this.auto_update=this.options.auto_update||!1,this.htmlRenderer=null,this.lifo=!1,this.init(this.options)}function u(e){s.call(this,e),this.dt="undefined"!=typeof e.dt?e.dt:null,"undefined"!=typeof e.dd&&(this.dd=e.dd)}var n=t.JSUS,r=t.NDDB,i=t.window.HTMLRenderer,s=t.window.HTMLRenderer.Entity;e.List=o,o.prototype=new r,o.prototype.constructor=o,o.prototype.init=function(e){e=e||this.options,this.FIRST_LEVEL=e.first_level||"dl",this.SECOND_LEVEL=e.second_level||"dt",this.THIRD_LEVEL=e.third_level||"dd",this.last_dt=0,this.last_dd=0,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:this.auto_update;var t=this.lifo="undefined"!=typeof e.lifo?e.lifo:this.lifo;this.globalCompare=function(e,n){if(!e&&!n)return 0;if(!n)return 1;if(!e)return-1;if(!t){if(e.dt<n.dt)return-1;if(e.dt>n.dt)return 1}else{if(e.dt<n.dt)return 1;if(e.dt>n.dt)return-1}if(e.dt===n.dt){if("undefined"==typeof e.dd)return-1;if("undefined"==typeof n.dd)return 1;if(e.dd<n.dd)return-1;if(e.dd>n.dd)return 1;if(e.nddbid<n.nddbid)return 1;if(e.nddbid>n.nddbid)return-1}return 0},this.DL=e.list||document.createElement(this.FIRST_LEVEL),this.DL.id=e.id||this.id,e.className&&(this.DL.className=e.className),this.options.title&&this.DL.appendChild(document.createTextNode(e.title)),this.htmlRenderer=new i(e.render)},o.prototype._add=function(e){if(!e)return;this.insert(e),this.auto_update&&this.parse()},o.prototype.addDT=function(e,t){if("undefined"==typeof e)return;this.last_dt++,t="undefined"!=typeof t?t:this.last_dt,this.last_dd=0;var n=new u({dt:t,content:e});return this._add(n)},o.prototype.addDD=function(e,t,n){if("undefined"==typeof e)return;t="undefined"!=typeof t?t:this.last_dt,n="undefined"!=typeof n?n:this.last_dd++;var r=new u({dt:t,dd:n,content:e});return this._add(r)},o.prototype.parse=function(){this.sort();var e=null,t=null,n=function(){var n=document.createElement(this.SECOND_LEVEL);return this.DL.appendChild(n),t=null,e=n,n},r=function(){var e=document.createElement(this.THIRD_LEVEL);return this.DL.appendChild(e),e};if(this.DL){while(this.DL.hasChildNodes())this.DL.removeChild(this.DL.firstChild);this.options.title&&this.DL.appendChild(document.createTextNode(this.options.title))}for(var i=0;i<this.db.length;i++){var s=this.db[i],o;"undefined"==typeof s.dd?o=n.call(this):o=r.call(this);var u=this.htmlRenderer.render(s);o.appendChild(u)}return this.DL},o.prototype.getRoot=function(){return this.DL},u.prototype=new s,u.prototype.constructor=u}("undefined"!=typeof node?"undefined"!=typeof node.window?node.window:node:module.parent.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){"use strict";function a(e,t){e=e||{},e.update||(e.update={}),"undefined"==typeof e.update.indexes&&(e.update.indexes=!0),s.call(this,e,t),this.row||this.index("row",function(e){return e.x}),this.col||this.index("col",function(e){return e.y}),this.rowcol||this.index("rowcol",function(e){return e.x+"_"+e.y}),this.defaultDim1=e.defaultDim1||"x",this.defaultDim2=e.defaultDim2||"y",this.defaultDim3=e.defaultDim3||"z",this.table=e.table||r.createElement("table"),this.id=e.id||"table_"+Math.round(Math.random()*1e3),this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:!1,this.missing=e.missing||"missing",this.pointers={x:e.pointerX||0,y:e.pointerY||0,z:e.pointerZ||0},this.header=[],this.footer=[],this.left=[],this.right=[],"undefined"!=typeof e.id&&(this.table.id=e.id,this.id=e.id),e.className&&(this.table.className=e.className),this.initRenderer(e.render)}function f(e){u.call(this,e),this.x="undefined"!=typeof e.x?e.x:null,this.y="undefined"!=typeof e.y?e.y:null,this.z="undefined"!=typeof e.z?e.z:null}var r=t.document;e.Table=a,e.Table.Cell=f;var i=n.JSUS,s=n.NDDB,o=n.window.HTMLRenderer,u=n.window.HTMLRenderer.Entity;a.prototype=new s,a.prototype.constructor=a,a.H=["x","y","z"],a.V=["y","x","z"],a.log=n.log,a.prototype.initRenderer=function(e){e=e||{},this.htmlRenderer=new o(e),this.htmlRenderer.addRenderer(function(e){var t,n;if("object"==typeof e.content){t=new a;for(n in e.content)e.content.hasOwnProperty(n)&&t.addRow([n,e.content[n]]);return t.parse()}},2)},a.prototype.get=function(e,t){if("undefined"!=typeof e&&"number"!=typeof e)throw new TypeError("Table.get: row must be number.");if("undefined"!=typeof t&&"number"!=typeof t)throw new TypeError("Table.get: col must be number.");return"undefined"==typeof e?this.col.get(t):"undefined"==typeof t?this.row.get(e):this.rowcol.get(e+"_"+t)},a.prototype.addClass=function(e){if("string"!=typeof e&&!i.isArray(e))throw new TypeError("Table.addClass: className must be string or array.");return i.isArray(e)&&(e=e.join(" ")),this.each(function(t){W.addClass(t,e)}),this.auto_update&&this.parse(),this},a.prototype.removeClass=function(e){var t;if("string"!=typeof e&&!i.isArray(e))throw new TypeError("Table.removeClass: className must be string or array.");return i.isArray(e)?t=function(e,t){for(var n=0;n<t.length;n++)W.removeClass(e,t[n])}:t=W.removeClass,this.each(function(n){t.call(this,n,e)}),this.auto_update&&this.parse(),this},a.prototype._addSpecial=function(e,t){var n,r;if(!e)return;t=t||"header";if("object"!=typeof e)return{content:e,type:t};n=[];for(r=0;r<e.length;r++)n.push({content:e[r],type:t});return n},a.prototype.setHeader=function(e){this.header=this._addSpecial(e,"header")},a.prototype.add2Header=function(e){this.header=this.header.concat(this._addSpecial(e))},a.prototype.setLeft=function(e){this.left=this._addSpecial(e,"left")},a.prototype.add2Left=function(e){this.left=this.left.concat(this._addSpecial(e,"left"))},a.prototype.setFooter=function(e){this.footer=this._addSpecial(e,"footer")},a._checkDim123=function(e){var t=a.H.slice(0);for(var n=0;n<e.length;n++)if(!i.removeElement(e[n],t))return!1;return!0},a.prototype.updatePointer=function(e,t){if(!e)return!1;if(!i.in_array(e,a.H))return a.log("Cannot update invalid pointer: "+e,"ERR"),!1;if(t>this.pointers[e])return this.pointers[e]=t,!0},a.prototype._add=function(e,t,n,r,i){if(!e)return!1;if(t){if(!a._checkDim123(t))return a.log("Invalid value for dimensions. Accepted only: x,y,z."),!1}else t=a.H;var s=function(e){var n={};n[t[0]]=u,n[t[1]]=l?r+l:r,n[t[2]]=c?i+c:i,n.content=e,this.insert(new f(n)),this.updatePointer(t[0],n[t[0]]),this.updatePointer(t[1],n[t[1]]),this.updatePointer(t[2],n[t[2]])};n=n||this.pointers[t[0]],r=r||this.pointers[t[1]]+1,i=i||this.pointers[t[2]],"object"!=typeof e&&(e=[e]);var o=null;for(var u=0;u<e.length;u++)if(e[u]instanceof Array){for(var l=0;l<e[u].length;l++)if(e[u][l]instanceof Array){for(var c=0;c<e[u][l].length;c++)s.call(this,e[u][l][c]);c=0}else s.call(this,e[u][l]);l=0}else s.call(this,e[u]);this.auto_update&&this.parse(!0)},a.prototype.add=function(e,t,n){if(!e)return;var r=e instanceof f?e:new f({x:t,y:n,content:e}),i=this.insert(r);return i&&(this.updatePointer("x",t),this.updatePointer("y",n)),i},a.prototype.addColumn=function(e,t,n){return e?this._add(e,a.V,t,n):!1},a.prototype.addRow=function(e,t,n){return e?this._add(e,a.H,t,n):!1},a.prototype.parse=function(){var e,t,n,i,s,o,u,a,f,l,c,h,p,d=function(e,t){var n,i;if(!e)return;return t=t||"td",n=r.createElement(t),i=this.htmlRenderer.render(e),n.appendChild(i),e.className&&(n.className=e.className),n};if(this.table)while(this.table.hasChildNodes())this.table.removeChild(this.table.firstChild);e=this.table;if(this.header&&this.header.length>0){i=r.createElement("thead"),t=r.createElement("tr"),this.left&&this.left.length>0&&t.appendChild(r.createElement("th"));for(u=0;u<this.header.length;u++)t.appendChild(d.call(this,this.header[u],"th"));i.appendChild(t),e.appendChild(i),u=0}if(this.size()){s=r.createElement("tbody"),this.sort(["y","x"]),a=-1,f=this.first(),l=f.x,c=0;for(u=0;u<this.db.length;u++){a!==this.db[u].y&&(t=r.createElement("tr"),s.appendChild(t),a=this.db[u].y,l=f.x-1,this.left&&this.left.length&&(n=r.createElement("td"),t.appendChild(d.call(this,this.left[c])),c++));if(this.db[u].x>l+1){h=this.db[u].x-(l+1);for(p=0;p<h;p++)n=r.createElement("td"),n.className=this.missing,t.appendChild(n)}t.appendChild(d.call(this,this.db[u])),l=this.db[u].x}e.appendChild(s)}if(this.footer&&this.footer.length>0){o=r.createElement("tfoot"),t=r.createElement("tr");for(u=0;u<this.header.length;u++)t.appendChild(d.call(this,this.footer[u]));o.appendChild(t),e.appendChild(o)}return e},a.prototype.resetPointers=function(e){if(e&&"object"!=typeof e)throw new TypeError("Table.resetPointers: pointers must be object or undefined.");e=e||{},this.pointers={x:e.pointerX||0,y:e.pointerY||0,z:e.pointerZ||0}},a.prototype.clear=function(e){s.prototype.clear.call(this,e)&&this.resetPointers()},f.prototype=new u,f.prototype.constructor=f}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node)